# Ccc Library Setup

The library was generated by executing `ng generate library ccc --entry-file=public_api --prefix=imx`

Additional fixes are required to support One Identity's dynamic modules

## ./imxweb

* angular.json
    * Under “ccc→architect→build→configurations” add:
        ```
        "dynamic": {
            "project": "projects/ccc/ng-package.dynamic.json"
        }
        ```
    * Under “ccc→architect→build→options“ add:
        ```
        "tsConfig": "projects/ccc/tsconfig.lib.json"
        ```
    * Under “ccc→architect→build” remove 
        ```
        "defaultConfiguration": "production"
        ```
* tsconfig.json
    * Add the following lines somewhere in “paths“:
        ```
        "ccc": ["dist/ccc"],
        "ccc/*": ["dist/ccc/*"],
        ```
    * Also check if "prefix" is set to “imx”

## ./imxweb/projects/ccc

* imx-plugin-config.json
    Create with the following code:
    ```
    {
    "qer-app-portal": [
        {
            "Container": "ccc",
            "Name": "CccModule"
        }
    ]
    }
    ```
    * Copy the file to: "{OneIM Program Folder}\imxweb\Html_ccc\imx-plugin-config.json"
    * **NOTE**: This is a very important step. What has been created is a dynamic module. It will not be loaded unless the API server tells the angular portal that it is an available module. If you are using the main API server, then the following steps must be done:
        * Create C:\inetpub\wwwroot\ApiServer\bin\imxweb\Html_ccc
        * Copy imx-plugin-config.json to C:\inetpub\wwwroot\ApiServer\bin\imxweb\Html_ccc
        * Recycle the API server application pool (not 100% sure this is required, but it doesn’t hurt)
* ng-package.dynamic.json
    * Copy it from “./projects/rms“
    * Change all occurences of “rms“ to “ccc“
* tslint.json
    * Copy from “rms”                        
* tsconfig.lib.prod.json
    Create/replace with the following code:
    ```
    {
    "extends": "./tsconfig.lib.json",
    "compilerOptions": {
        "declarationMap": false
    },
    "angularCompilerOptions": {
        "compilationMode": "partial",
        "enableIvy": true
    }
    }
    ```
* imx-project.json (not existing/needed in newer versions)
    * Copy it from “./projects/rms“
    * Change all occurences of “rms“ to “ccc“

# API Server Setup

## Enable CCC module on API Server

There are two options. The imxweb\Html_ccc\imx-plugin-config.json can be placed in the One Identity tools directory and loaded in to the database OR the file can be placed in the IIS INETPUB directory manually.

Tools Directory
    * Create {One Identity Tools Directory}\imxweb\Html_ccc
    * Copy imx-plugin-config.json to \imxweb\Html_ccc
    * Open SoftwareLoader.exe and select imx-plugin-config.json
    * Select Web\Business API server as the deploy target 

Manually
    * Create C:\inetpub\wwwroot\ApiServer\bin\imxweb\Html_ccc
    * Copy imx-plugin-config.json to C:\inetpub\wwwroot\ApiServer\bin\imxweb\Html_ccc
    * Recycle the API server application pool (not 100% sure this is required, but it doesn’t hurt)

To confirm that the CCC module is enabled, view the response to the /imx/application endpoint in the Network tab of the developer tools of Chrome. The CCC module should be included in the response:

Reference:
* https://support.oneidentity.com/technical-documents/identity-manager/9.2/html5-development-guide/3#TOPIC-2085658

## Disable CSRF

If you use the One Identit API in the environment, you'll need to disable CSRF:
    * Go to the API admin portal : https://oneidm/ApiServer/html/qbm-app-landingpage/#/login
    * Login, for example with an administrative system user
    * Find Globally disable CSRF protection tokens and check the box:

## Change SameSite cookie setting

* Launch Designer
* Edit Configuration Parameters
* Change **QBM\ApiServer\Defaults\SameSiteCookie** -> "none;Secure"

## IIS Setup

* Ensure Anonymous access is enabled


# Adding code

## Code scaffolding

Run `ng generate component component-name --project ccc --style=scss --export --prefix=ccc --skip-tests` to generate a new component. You can also use `ng generate directive|pipe|service|class|guard|interface|enum|module --project ccc`.
> Note: Don't forget to add `--project ccc` or else it will be added to the default project in your `angular.json` file. 

## Create components for Hello and Goodbye Dashboard tiles
```
ng generate component hello-dashboard-tile --project=ccc --style=scss --export --prefix=ccc --skip-tests
ng generate component goodbye-dashboard-tile --project=ccc --style=scss --export --prefix=ccc --skip-tests
```

## Create component for HelloWorld menu item
```
ng generate component hello-world-menuitem --project=ccc --style=scss --export --prefix=ccc --skip-tests
```


# How classes are loaded

* angular.json 
    - defines the CCC libary. We consider this a dynamic module and architect->build->dynamic points to projects/ccc/ng-package.dynamic.json
* projects/ccc/ng-package.dynamic.json 
    - defines the compile destination : ../../html/ccc
    - defines the entry file to begin loading classes : src/public_api
* projects/ccc/src/public_api.ts
    - exports modules, services and all exported components from ccc.module.ts
* projects/ccc/src/lib/ccc.module.ts
    - The first class to be run
    - The constructor initializes an instance of CccService called initializer. this.initalizer.onInit() calls the onInit method in the service
    - custom routes can be defined here and pass to the service using the onInit() method
* projects/ccc/src/lib/ccc.service.ts
    - custom routes are processed
    - menu items registered. 
        menu items point to routes. routes point to components in ccc.module.ts
    - dashboard tiles registered
        references the component that handles the dashboard tile
            this.extService.register('Dashboard-SmallTiles', {instance: HelloDashboardTileComponent})
            this.extService.register('Dashboard-SmallTiles', {instance: GoodbyeDashboardTileComponent})
